<!doctype html>
<html>

<head>
    <script src="node_modules/az/dist/az.min.js"></script>
</head>

<body>
    <div id="text">
        <p>Неудовлетворенность <strong>отношениями</strong> вышла на первый план</p>
    </div>

    <div id="full">
        <p>Американские <strong>психологи</strong> выявили основные причины, по которым люди изменяют своим
            партнерам.Неудовлетворенность
            отношениями вышла на первый план, а вот заинтересованность в человеке, с которым
            изменяют, оказалась не столь важным фактором. Об <a
                href="https://www.tandfonline.com/doi/full/10.1080/00224499.2020.1746954">исследовании</a>,
            опубликованном в The Journal of Sex Research, <a
                href="https://www.psypost.org/2020/05/new-psychology-research-sheds-light-on-motivations-to-engage-in-infidelity-56823">пишет</a>
            PsyPost.</p>
        <p>В выборку вошли 545 пользователей сайта AshleyMadison.com, где собираются женатые люди, ищущие отношений на
            стороне. Большинство опрошенных (81%) — мужчины, средний возраст участников — около 48&nbsp; лет. В
            анонимной анкете респондентов попросили уточнить причины, по которым они пошли на измену.</p>
        <h4><strong>Как правило, участники говорили о разочаровании в существующих отношениях — и о том, что они
                разлюбили свою половину. При этом личность нового человека, появившегося в их жизни, не играла большой
                роли.</strong></h4>
        <p>И мужчины, и женщины, для которых случайный секс был чем-то приемлемым, и к неверности относились довольно
            легко. Женщины и те участники, которые не были удовлетворены существующими отношениями, зачастую искали
            романы на стороне от чувства одиночества — в паре им не хватало внимания.</p>
    </div>

    <script>
        const forms = {
            'sing:masc:nomn': 'русский',
            'sing:masc:gent': 'русского',
            'sing:masc:datv': 'русскому',
            'sing:masc:accs': 'русский',
            'sing:masc:ablt': 'русским',
            'sing:masc:loct': 'русском',

            'sing:femn:nomn': 'русская',
            'sing:femn:gent': 'русской',
            'sing:femn:datv': 'русской',
            'sing:femn:accs': 'русскую',
            'sing:femn:ablt': 'русской',
            'sing:femn:loct': 'русской',

            'sing:neut:nomn': 'русское',
            'sing:neut:gent': 'русского',
            'sing:neut:datv': 'русскому',
            'sing:neut:accs': 'русское',
            'sing:neut:ablt': 'русским',
            'sing:neut:loct': 'русском',

            'plur:nomn': 'русские',
            'plur:gent': 'русских',
            'plur:datv': 'русским',
            'plur:accs': 'русские',
            'plur:ablt': 'русскими',
            'plur:loct': 'русских'
        }

        function getAdjective(tag) {
            let form = [];

            form.push(tag.NMbr);

            if (tag.NMbr === 'sing') {
                form.push(tag.GNdr);
            }

            form.push(tag.CAse);

            let key = form.join(':');

            return forms[key] + ' ';
        }

        function checkPos(token, pos) {
            if (token) {
                let parses = Az.Morph(token.toString());

                if (!parses[0]) {
                    return false;
                }

                if (parses[0].tag.POS === pos) {
                    return parses[0];
                }
            }

            return false;
        }

        function addAdjective(data) {
            let tokens = Az.Tokens(data, {
                html: true
            }).done();

            console.log(tokens);

            let updated = [];

            tokens.forEach(function (token, i) {
                // Skip first word or proper nouns and non-cyrillic
                if (token.allUpper || token.type.toString() !== 'WORD') {
                    return updated.push(token.toString());
                }

                // Skip if prev token adjective
                if (checkPos(tokens[i - 1], 'ADJF')) {
                    return updated.push(token.toString());
                }

                const current = checkPos(token, 'NOUN');

                if (!current) {
                    return updated.push(token.toString());
                }

                const adjective = getAdjective(current.tag);

                updated.push('<span>' + adjective + token.toString() + '</span>');
            });

            return updated.join('');
        }

        function traverseChildNodes(node, done) {
            var next;

            if (node.nodeType === 1) {
                if (node = node.firstChild) {
                    do {
                        next = node.nextSibling;
                        traverseChildNodes(node, done);
                    } while (node = next);
                }
            } else if (node.nodeType === 3) {
                done(node);
            }
        }

        Az.Morph.init('../dicts', function (err, Morph) {
            var elements = document.querySelectorAll('#text > *');

            elements.forEach(function (element) {
                traverseChildNodes(element, function (node) {

                    let text = addAdjective(node.data);
                    console.log(node.parentNode);

                    node.innerHTML = text;
                })
            });
        });
    </script>
</body>

</html>